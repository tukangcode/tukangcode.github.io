<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Report Generator v1 - </title>
    <!-- Frameworks & Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.16/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #3b82f6; --secondary: #64748b; --dark: #1e293b; --light: #f8fafc;
            --card-bg: white; --border-color: rgba(0, 0, 0, 0.1);
        }
        html.dark {
            --primary: #60a5fa; --secondary: #94a3b8; --dark: #f8fafc; --light: #1e293b;
            --card-bg: #2d3748; --border-color: rgba(255, 255, 255, 0.1);
        }
        body { background-color: var(--light); color: var(--dark); font-family: 'Segoe UI', sans-serif; }
        #map { height: 400px; border-radius: 0.5rem; background-color: #e5e7eb; }
        .form-container, .report-container { max-width: 1200px; margin: 1rem auto 0; padding: 1.5rem; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; border: none; transition: all 0.2s; }
        .btn-primary { background-color: var(--primary); color: white; } .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: var(--secondary); color: white; } .btn-secondary:hover { background-color: #475569; }
        .btn-sm { padding: 0.3rem 0.8rem; font-size: 0.875rem; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: var(--card-bg); margin: 10% auto; padding: 20px; border: 1px solid var(--border-color); width: 80%; max-width: 700px; border-radius: 0.75rem; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        #reportOutputSection.compact-mode #report-content { padding: 0.5rem !important; }
        #reportOutputSection.compact-mode h2 { font-size: 1.2rem !important; }
        #reportOutputSection.compact-mode .report-section-header { font-size: 1rem !important; margin-bottom: 5px !important; }
        #reportOutputSection.compact-mode p, #reportOutputSection.compact-mode li { font-size: 0.8rem !important; line-height: 1.3 !important; }
        @media print {
            body * { visibility: hidden; }
            #reportOutputSection, #reportOutputSection * { visibility: visible; }
            #reportOutputSection { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; border: none; box-shadow: none; }
            #report-action-buttons { display: none; }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
    <!-- Header -->
    <div class="container mx-auto px-4 py-6 flex justify-between items-center">
        <h1 class="text-3xl lg:text-4xl font-bold text-gray-800 dark:text-white">Advanced Report Generator</h1>
        <div class="flex items-center gap-4">
            <button id="historyBtn" class="btn btn-secondary"><i class="fas fa-history"></i> Riwayat</button>
            <!-- Dark Mode Toggle will be added via JS -->
        </div>
    </div>

    <div class="container mx-auto px-4 pb-8">
        <div class="form-container">
            <form id="eventForm">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-8 gap-y-6">
                    <!-- Left Column -->
                    <div>
                        <h3 class="text-xl font-semibold border-b dark:border-gray-600 pb-2 mb-4">Informasi Kejadian</h3>
                        <div class="mb-4">
                            <label for="eventName" class="block text-sm font-medium">Nama Kejadian</label>
                            <input type="text" id="eventName" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-800 dark:border-gray-700" required>
                        </div>
                        <div class="mb-4">
                            <label for="eventDetails" class="block text-sm font-medium">Detail Kejadian</label>
                            <textarea id="eventDetails" rows="5" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-800 dark:border-gray-700" required></textarea>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="eventDate" class="block text-sm font-medium">Tanggal</label>
                                <input type="date" id="eventDate" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-800 dark:border-gray-700" required>
                            </div>
                           <div>
    <label for="eventCategory" class="block text-sm font-medium">Kategori</label>
    <select id="eventCategory" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-800 dark:border-gray-700">
        <optgroup label="Insiden & Bencana">
            <option>Kriminal</option>
            <option>Bencana</option>
            <option>Konflik</option>
            <option>Lingkungan</option>
        </optgroup>
        <optgroup label="Entitas & Acara">
            <option>Pemerintah</option>
            <option>LSM</option>
            <option>Perusahaan</option>
            <option>Event</option>
            <option>Festival</option>
        </optgroup>
    </select>
</div>                      
                      </div>
                        <h3 class="text-lg font-semibold mt-6 mb-2">Gambar & Sumber</h3>
                        <div id="image-inputs-container"></div>
                        <div id="source-inputs-container"></div>
                    </div>

                    <!-- Right Column -->
                    <div>
                        <h3 class="text-xl font-semibold border-b dark:border-gray-600 pb-2 mb-4">Lokasi & Peta</h3>
                        <div id="map"></div>
                        <div class="mb-4 mt-4">
                            <label for="eventLocationCoordinates" class="block text-sm font-medium">Koordinat (klik peta atau cari)</label>
                            <input type="text" id="eventLocationCoordinates" class="w-full p-2 border rounded-md bg-gray-200 dark:bg-gray-700" readonly required>
                            <div id="form-map-links" class="text-xs mt-1" style="display: none;"></div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="iconSelect" class="block text-sm font-medium">Ikon Peta</label>
                                <select id="iconSelect" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-800 dark:border-gray-700">
                                    <optgroup label="Darurat & Kriminal">
                                        <option value="fa-car-burst" data-color="#ef4444">Kecelakaan</option>
                                        <option value="fa-fire-flame-curved" data-color="#f97316">Kebakaran</option>
                                        <option value="fa-skull-crossbones" data-color="#a855f7">Baku Tembak</option>
                                        <option value="fa-handcuffs" data-color="#3b82f6">Polisi</option>
                                        <option value="fa-users-slash" data-color="#78716c">Geng</option>
                                    </optgroup>
                                    <optgroup label="Militer & Konflik">
                                        <option value="fa-helicopter" data-color="#14b8a6">Tentara</option>
                                        <option value="fa-person-rifle" data-color="#ef4444">Tentara Musuh</option>
                                        <option value="fa-flag" data-color="#f59e0b">Pemberontak</option>
                                        <option value="fa-users" data-color="#84cc16">Perusuh</option>
                                    </optgroup>
                                    <optgroup label="Bencana Alam">
                                        <option value="fa-house-flood-water" data-color="#0ea5e9">Banjir</option>
                                        <option value="fa-hill-rockslide" data-color="#a16207">Longsor</option>
                                    </optgroup>
                                    <optgroup label="Lainnya">
                                        <option value="fa-person-digging" data-color="#eab308">Perbaikan</option>
                                        <option value="fa-map-marker-alt" data-color="#64748b" selected>Default</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div>
                                <label for="eventRadius" class="block text-sm font-medium">Radius Dampak</label>
                                <select id="eventRadius" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-800 dark:border-gray-700">
                                    <option value="50">50m</option><option value="100">100m</option><option value="250">250m</option><option value="500">500m</option>
                                    <option value="1000" selected>1km</option><option value="2000">2km</option><option value="3000">3km</option><option value="5000">5km</option>
                                    <option value="7500">7.5km</option><option value="10000">10km</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 pt-6 border-t dark:border-gray-600">
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2 text-lg font-semibold">
                        <i class="fas fa-file-alt"></i> Buat Laporan
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Report Display Section -->
        <div id="reportOutputSection" class="report-container" style="display: none;">
            <div id="report-action-buttons" class="mb-4 flex flex-wrap gap-2"></div>
            <div id="report"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" data-modal="historyModal">×</span>
            <h2 class="text-2xl font-bold mb-4">Riwayat Laporan</h2>
            <div id="historyList" class="max-h-96 overflow-y-auto"></div>
            <button id="clearHistoryBtn" class="btn btn-secondary mt-4"><i class="fas fa-trash"></i> Bersihkan Riwayat</button>
        </div>
    </div>
    <div id="rawCodeModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" data-modal="rawCodeModal">×</span>
            <h2 class="text-2xl font-bold mb-4">Kode Mentah Laporan (HTML)</h2>
            <textarea id="rawCodeTextarea" readonly class="w-full h-64 p-2 border rounded-md bg-gray-100 dark:bg-gray-800 dark:border-gray-700 font-mono text-sm"></textarea>
            <button id="copyRawCodeBtn" class="btn btn-primary mt-4"><i class="fas fa-copy"></i> Salin Kode</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Globals & Element References ---
        let map, marker, circle, reportMapInstance;
        const reportHistory = JSON.parse(localStorage.getItem('reportHistory')) || [];
        
        const ELS = {
            form: document.getElementById('eventForm'),
            reportOutputSection: document.getElementById('reportOutputSection'),
            reportContainer: document.getElementById('report'),
            coordsInput: document.getElementById('eventLocationCoordinates'),
            iconSelect: document.getElementById('iconSelect'),
            radiusSelect: document.getElementById('eventRadius'),
            formMapLinks: document.getElementById('form-map-links'),
            reportActionButtons: document.getElementById('report-action-buttons'),
            historyBtn: document.getElementById('historyBtn'),
            historyModal: document.getElementById('historyModal'),
            historyList: document.getElementById('historyList'),
            clearHistoryBtn: document.getElementById('clearHistoryBtn'),
            rawCodeModal: document.getElementById('rawCodeModal'),
            rawCodeTextarea: document.getElementById('rawCodeTextarea'),
            copyRawCodeBtn: document.getElementById('copyRawCodeBtn'),
        };

        // --- Initial Setup ---
        function populateDynamicFields() {
            const imageContainer = document.getElementById('image-inputs-container');
            for (let i = 1; i <= 2; i++) {
                imageContainer.innerHTML += `
                    <div class="border dark:border-gray-700 p-2 rounded-md mb-2">
                        <label for="imageLink${i}" class="block text-xs font-medium">Link Gambar ${i}:</label>
                        <input type="url" id="imageLink${i}" placeholder="https://example.com/image.jpg" class="w-full p-1 border rounded-md bg-gray-50 dark:bg-gray-800 dark:border-gray-700">
                    </div>`;
            }
            const sourceContainer = document.getElementById('source-inputs-container');
            for (let i = 1; i <= 2; i++) {
                sourceContainer.innerHTML += `
                    <div class="mb-2">
                        <label for="eventSource${i}" class="block text-xs font-medium">Sumber ${i}:</label>
                        <input type="text" id="eventSource${i}" class="w-full p-1 border rounded-md bg-gray-50 dark:bg-gray-800 dark:border-gray-700">
                    </div>`;
            }
        }

        function initMap() {
            const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' });
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '© Esri' });

            map = L.map('map', { layers: [streetLayer], zoomControl: true }).setView([-2.5489, 118.0149], 5); // Center on Indonesia
            map.zoomControl.setPosition('topright');
            L.control.layers({ "Jalan": streetLayer, "Satelit": satelliteLayer }, null, { position: 'topright' }).addTo(map);

            L.Control.geocoder({ defaultMarkGeocode: false, placeholder: 'Cari alamat...', position: 'topleft' })
                .on('markgeocode', e => updateMarkerAndCircle(e.geocode.center, 15))
                .addTo(map);
            
            // NEW: Locate Control
            L.control.locate({
                position: 'topleft',
                strings: { title: "Lacak lokasi saya" },
                flyTo: true,
                returnToPrevBounds: true
            }).addTo(map);

            map.on('click', e => updateMarkerAndCircle(e.latlng));
            ELS.iconSelect.addEventListener('change', () => updateMarkerAndCircle(marker ? marker.getLatLng() : null));
            ELS.radiusSelect.addEventListener('change', () => updateMarkerAndCircle(marker ? marker.getLatLng() : null));
        }

        // --- Map & Marker Logic ---
        function createIcon(iconClass, color) {
            return L.divIcon({
                html: `<i class="fas ${iconClass}" style="color: ${color}; font-size: 24px; text-shadow: 0 0 3px rgba(0,0,0,0.7);"></i>`,
                className: 'leaflet-div-icon',
                iconSize: [24, 24],
                iconAnchor: [12, 24]
            });
        }

        function updateMarkerAndCircle(latlng, zoomLevel) {
            if (!latlng) return;
            ELS.coordsInput.value = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
            if (marker) map.removeLayer(marker);
            if (circle) map.removeLayer(circle);

            const selectedOption = ELS.iconSelect.options[ELS.iconSelect.selectedIndex];
            marker = L.marker(latlng, { icon: createIcon(selectedOption.value, selectedOption.dataset.color) }).addTo(map);

            const radius = parseInt(ELS.radiusSelect.value, 10);
            circle = L.circle(latlng, { radius: radius, color: '#3b82f6', fillOpacity: 0.15 }).addTo(map);

            if (zoomLevel) {
                map.setView(latlng, zoomLevel);
            } else {
                map.fitBounds(circle.getBounds(), { padding: [50, 50] });
            }
            updateFormMapLinks(latlng.lat, latlng.lng);
        }

        // NEW: Update map links on the form
        function updateFormMapLinks(lat, lon) {
            ELS.formMapLinks.innerHTML = `
                Cek di: 
                <a href="https://maps.google.com/?q=${lat},${lon}" target="_blank" class="text-blue-500 hover:underline">Google</a> |
                <a href="https://www.bing.com/maps?cp=${lat}~${lon}&lvl=16" target="_blank" class="text-blue-500 hover:underline">Bing</a> |
                <a href="https://maps.apple.com/?ll=${lat},${lon}" target="_blank" class="text-blue-500 hover:underline">Apple</a>
            `;
            ELS.formMapLinks.style.display = 'block';
        }

        // --- Form Submission ---
        ELS.form.addEventListener('submit', e => {
            e.preventDefault();
            if (!ELS.coordsInput.value) {
                showToast('Silakan pilih lokasi di peta.', 'error'); return;
            }
            
            const selectedIconOption = ELS.iconSelect.options[ELS.iconSelect.selectedIndex];
            const reportData = {
                id: Date.now(),
                name: document.getElementById('eventName').value,
                details: document.getElementById('eventDetails').value,
                date: document.getElementById('eventDate').value,
                category: document.getElementById('eventCategory').value,
                images: [document.getElementById('imageLink1').value, document.getElementById('imageLink2').value].filter(Boolean),
                sources: [document.getElementById('eventSource1').value, document.getElementById('eventSource2').value].filter(Boolean),
                coords: ELS.coordsInput.value.split(',').map(Number),
                zoom: map.getZoom(),
                radius: parseInt(ELS.radiusSelect.value, 10),
                iconClass: selectedIconOption.value,
                iconColor: selectedIconOption.dataset.color,
            };

            generateReport(reportData);
            saveReportToHistory(reportData);
            showToast('Laporan berhasil dibuat!', 'success');
            ELS.reportOutputSection.scrollIntoView({ behavior: 'smooth' });
        });

        // --- Report Generation ---
        function generateReport(data) {
            const reportHtml = generateReportHTML(data);
            ELS.reportContainer.innerHTML = reportHtml;
            setupActionButtons(data);
            ELS.reportOutputSection.style.display = 'block';
            initReportMap(data);
        }

        function generateReportHTML(data) {
            const formattedDate = new Date(data.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            const imageHtml = data.images.length > 0 ? `
                <div class="mb-5"><h3 class="report-section-header">Gambar Pendukung</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                        ${data.images.map(src => `<a href="${src}" target="_blank" rel="noopener noreferrer"><img src="${src}" alt="Gambar Kejadian" class="w-full h-auto rounded-md border dark:border-gray-600"></a>`).join('')}
                    </div>
                </div>` : '';
            const sourceHtml = data.sources.length > 0 ? `
                <div class="mb-5"><h3 class="report-section-header">Sumber Referensi</h3>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        ${data.sources.map(src => `<li><a href="${src}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline break-all">${src}</a></li>`).join('')}
                    </ul>
                </div>` : '';
            const [lat, lon] = data.coords;
            const coordinateLinks = `
                <a href="https://maps.google.com/?q=${lat},${lon}" target="_blank" class="text-blue-500 hover:underline">Google Maps</a> | 
                <a href="https://www.bing.com/maps?cp=${lat}~${lon}&lvl=16" target="_blank" class="text-blue-500 hover:underline">Bing Maps</a> | 
                <a href="https://maps.apple.com/?ll=${lat},${lon}&q=Lokasi" target="_blank" class="text-blue-500 hover:underline">Apple Maps</a>`;

            return `
                <style>.report-section-header { font-size: 1.125rem; font-weight: bold; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-bottom: 10px; }</style>
                <div id="report-content" class="p-4 rounded-lg bg-white dark:bg-gray-800 text-black dark:text-white">
                    <div class="text-center border-b-2 dark:border-gray-600 pb-3 mb-5">
                        <h2 class="text-2xl font-bold mb-1">${data.name}</h2>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Kategori: <strong>${data.category}</strong> | Tanggal: <strong>${formattedDate}</strong></p>
                    </div>
                    <div class="mb-5"><h3 class="report-section-header">Detail Kejadian</h3><p class="leading-relaxed whitespace-pre-wrap">${data.details}</p></div>
                    ${imageHtml}
                    <div class="mb-5">
                        <h3 class="report-section-header">Lokasi</h3>
                        <p>Koordinat: <strong>${data.coords.join(', ')}</strong></p>
                        <p class="text-sm mt-1">${coordinateLinks}</p>
                        <div id="reportMapContainer" class="w-full h-64 border border-gray-300 rounded-md mt-2"></div>
                    </div>
                    ${sourceHtml}
                </div>`;
        }

        function initReportMap(data) {
            if (reportMapInstance) reportMapInstance.remove();
            const latlng = L.latLng(data.coords[0], data.coords[1]);
            reportMapInstance = L.map('reportMapContainer', { scrollWheelZoom: false, zoomControl: true }).setView(latlng, data.zoom);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(reportMapInstance);
            L.marker(latlng, { icon: createIcon(data.iconClass, data.iconColor) }).addTo(reportMapInstance);
            L.circle(latlng, { radius: data.radius, color: '#3b82f6', fillOpacity: 0.15 }).addTo(reportMapInstance);
        }

        // NEW: Action Buttons (PDF, Compact, Raw Code)
        function setupActionButtons(data) {
            ELS.reportActionButtons.innerHTML = `
                <button id="pdfBtn" class="btn btn-sm btn-primary"><i class="fas fa-file-pdf"></i> Jadikan PDF</button>
                <button id="compactBtn" class="btn btn-sm btn-secondary"><i class="fas fa-compress-alt"></i> Mode Ringkas</button>
                <button id="rawCodeBtn" class="btn btn-sm btn-secondary"><i class="fas fa-code"></i> Kode Mentah</button>
            `;
            document.getElementById('pdfBtn').onclick = () => window.print();
            document.getElementById('compactBtn').onclick = () => ELS.reportOutputSection.classList.toggle('compact-mode');
            document.getElementById('rawCodeBtn').onclick = () => {
                const reportContent = document.getElementById('report-content').innerHTML;
                const prettyHtml = '<div>\n' + reportContent.split('><').join('>\n<') + '\n</div>';
                ELS.rawCodeTextarea.value = prettyHtml;
                ELS.rawCodeModal.style.display = 'block';
            };
        }

        // NEW: History Logic
        function saveReportToHistory(data) {
            reportHistory.unshift(data);
            if (reportHistory.length > 50) reportHistory.pop(); // Limit history size
            localStorage.setItem('reportHistory', JSON.stringify(reportHistory));
            renderHistoryList();
        }

        function renderHistoryList() {
            if (reportHistory.length === 0) {
                ELS.historyList.innerHTML = '<p class="text-gray-500">Tidak ada riwayat.</p>';
                return;
            }
            ELS.historyList.innerHTML = reportHistory.map(item => {
                const date = new Date(item.date).toLocaleDateString('id-ID');
                return `<div class="p-2 border-b dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer" data-id="${item.id}">
                    <p class="font-semibold">${item.name}</p>
                    <p class="text-sm text-gray-500">${date} - ${item.coords.join(', ')}</p>
                </div>`;
            }).join('');
        }
        
        ELS.historyList.addEventListener('click', e => {
            const itemEl = e.target.closest('[data-id]');
            if (itemEl) {
                const reportId = parseInt(itemEl.dataset.id, 10);
                const reportData = reportHistory.find(r => r.id === reportId);
                if (reportData) {
                    generateReport(reportData);
                    ELS.historyModal.style.display = 'none';
                    showToast('Laporan dari riwayat dimuat.', 'info');
                    ELS.reportOutputSection.scrollIntoView({ behavior: 'smooth' });
                }
            }
        });

        ELS.clearHistoryBtn.addEventListener('click', () => {
            if (confirm('Apakah Anda yakin ingin menghapus semua riwayat laporan?')) {
                reportHistory.length = 0;
                localStorage.removeItem('reportHistory');
                renderHistoryList();
                showToast('Riwayat berhasil dihapus.', 'success');
            }
        });
        
        // --- Modal & Utility Logic ---
        ELS.historyBtn.addEventListener('click', () => {
            renderHistoryList();
            ELS.historyModal.style.display = 'block';
        });
        
        ELS.copyRawCodeBtn.addEventListener('click', () => {
            ELS.rawCodeTextarea.select();
            document.execCommand('copy');
            showToast('Kode berhasil disalin ke clipboard!', 'success');
        });

        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById(btn.dataset.modal).style.display = 'none';
            });
        });

        window.addEventListener('click', e => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
        
        function showToast(message, type = 'info') {
            const colors = {
                success: 'linear-gradient(to right, #00b09b, #96c93d)',
                error: 'linear-gradient(to right, #ff5f6d, #ffc371)',
                info: 'linear-gradient(to right, #3f51b5, #2196f3)'
            };
            Toastify({
                text: message, duration: 3000, gravity: "bottom", position: "right",
                style: { background: colors[type] || colors.info }
            }).showToast();
        }
        
        // --- Final Initialization Calls ---
        populateDynamicFields();
        initMap();
    });
    </script>
</body>
</html>
